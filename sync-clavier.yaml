blueprint:
  name: Sync Alarmo & Frient Keypad (Smart Validation)
  description: >
    Synchronisation bidirectionnelle. 
    Vérifie si Alarmo a accepté le code avant de confirmer au clavier (Succès = Vert, Code faux/Erreur capteur = Rouge).
  domain: automation
  input:
    alarm_panel:
      name: Alarmo Entity
      description: L'entité de l'alarme Alarmo.
      selector:
        entity:
          domain: alarm_control_panel
    keypad_topic:
      name: Topic MQTT de commande
      description: "Ex: zigbee2mqtt/Clavier_Entree"
      selector:
        text:
    arm_without_code:
      name: Autoriser l'armement sans code
      description: "Active l'armement immédiat sans code (Décocher 'Code requis' dans Alarmo)."
      default: false
      selector:
        boolean: {}

mode: parallel
max: 10

trigger:
  - platform: state
    entity_id: !input alarm_panel
    id: "alarm_state_change"
  - platform: mqtt
    topic: !input keypad_topic
    id: "keypad_action"

variables:
  keypad_topic: !input keypad_topic
  alarm_panel: !input alarm_panel
  arm_without_code: !input arm_without_code

action:
  - choose:
      # ---------------------------------------------------------
      # 1. ALARMO CHANGE D'ÉTAT -> MAJ LEDS
      # ---------------------------------------------------------
      - conditions:
          - condition: trigger
            id: "alarm_state_change"
        sequence:
          - service: mqtt.publish
            data:
              topic: "{{ keypad_topic }}/set"
              payload: >
                {% set state = trigger.to_state.state %}
                {% if state == 'armed_away' %} {"arm_mode": {"mode": "arm_all_zones"}}
                {% elif state == 'armed_home' %} {"arm_mode": {"mode": "arm_day_zones"}}
                {% elif state == 'armed_night' %} {"arm_mode": {"mode": "arm_night_zones"}}
                {% elif state == 'disarmed' %} {"arm_mode": {"mode": "disarm"}}
                {% elif state == 'pending' %} {"arm_mode": {"mode": "entry_delay"}}
                {% elif state == 'arming' %} {"arm_mode": {"mode": "exit_delay"}}
                {% else %} {"arm_mode": {"mode": "disarm"}}
                {% endif %}

      # ---------------------------------------------------------
      # 2. ACTION CLAVIER -> COMMANDE ALARME AVEC VÉRIFICATION
      # ---------------------------------------------------------
      - conditions:
          - condition: trigger
            id: "keypad_action"
        sequence:
          - variables:
              action: "{{ trigger.payload_json.action }}"
              code: "{{ trigger.payload_json.action_code | default('') }}"
              transaction: "{{ trigger.payload_json.action_transaction }}"
          
          - choose:
              # --- CAS A : ARMEMENT ---
              - conditions:
                  - condition: template
                    value_template: >
                      {{ action in ['arm_all_zones', 'arm_day_zones', 'arm_night_zones'] and 
                         (arm_without_code == true or code != '') }}
                sequence:
                  # 1. On tente d'armer Alarmo
                  - service: >
                      {% if action == 'arm_all_zones' %} alarm_control_panel.alarm_arm_away
                      {% elif action == 'arm_day_zones' %} alarm_control_panel.alarm_arm_home
                      {% else %} alarm_control_panel.alarm_arm_night
                      {% endif %}
                    target:
                      entity_id: !input alarm_panel
                    data:
                      code: "{{ code }}"
                  
                  # 2. Petite pause pour laisser Alarmo réagir (0.5s est suffisant généralement)
                  - delay: "00:00:00.5"

                  # 3. Vérification : Est-ce que ça a marché ?
                  # On vérifie si l'alarme est passée en 'arming' (délai sortie) ou 'armed_...'
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ states(alarm_panel) in ['arming', 'armed_away', 'armed_home', 'armed_night'] }}"
                        sequence:
                          # SUCCÈS : On confirme au clavier
                          - service: mqtt.publish
                            data:
                              topic: "{{ keypad_topic }}/set"
                              payload: "{\"arm_mode\": {\"transaction\": {{transaction}}, \"mode\": \"{{action}}\"}}"
                      
                      # ÉCHEC (Code faux ou capteur ouvert)
                      - conditions:
                          - condition: template
                            value_template: "{{ true }}" # Action par défaut
                        sequence:
                          - service: mqtt.publish
                            data:
                              topic: "{{ keypad_topic }}/set"
                              payload: "{\"arm_mode\": {\"transaction\": {{transaction}}, \"mode\": \"invalid_code\"}}"

              # --- CAS B : DÉSARMEMENT ---
              - conditions:
                  - condition: template
                    value_template: "{{ action == 'disarm' and code != '' }}"
                sequence:
                  # 1. On tente de désarmer
                  - service: alarm_control_panel.alarm_disarm
                    target:
                      entity_id: !input alarm_panel
                    data:
                      code: "{{ code }}"
                  
                  # 2. Pause
                  - delay: "00:00:00.5"

                  # 3. Vérification
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ is_state(alarm_panel, 'disarmed') }}"
                        sequence:
                          # SUCCÈS
                          - service: mqtt.publish
                            data:
                              topic: "{{ keypad_topic }}/set"
                              payload: "{\"arm_mode\": {\"transaction\": {{transaction}}, \"mode\": \"disarm\"}}"
                      
                      # ÉCHEC (Code faux)
                      - conditions:
                          - condition: template
                            value_template: "{{ true }}"
                        sequence:
                          - service: mqtt.publish
                            data:
                              topic: "{{ keypad_topic }}/set"
                              payload: "{\"arm_mode\": {\"transaction\": {{transaction}}, \"mode\": \"invalid_code\"}}"

              # --- CAS C : AUTRE (Code manquant ou erreur technique) ---
              - conditions:
                  - condition: template
                    value_template: "{{ transaction is defined }}"
                sequence:
                  - service: mqtt.publish
                    data:
                      topic: "{{ keypad_topic }}/set"
                      payload: "{\"arm_mode\": {\"transaction\": {{transaction}}, \"mode\": \"invalid_code\"}}"
